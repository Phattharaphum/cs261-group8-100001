<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ตรวจสอบคำร้อง</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700;900&display=swap"
      as="style"
      onload="this.rel='stylesheet'"
    />
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Bai+Jamjuree:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700&display=swap"
      as="style"
      onload="this.rel='stylesheet'"
    />
    <link rel="stylesheet" href="css/studentPetitionsChecked.css" />
    <link rel="stylesheet" href="css/stylesidebar.css" />
    <script defer src="./js/redirect-handler.js"></script>
    <style>
      /* สไตล์สำหรับแถบสถานะ */
      .status-label {
        padding: 5px 10px;
        border-radius: 15px;
        color: white;
        font-weight: bold;
      }
      .status-waiting {
        background-color: #ffe6a7;
        color: #b68900;
      }
      .status-read {
        background-color: #e0b0ff;
        color: #8e44ad;
      }
      .status-rejected {
        background-color: #ffcdd2;
        color: #c62828;
      }
      .status-approved {
        background-color: #a5d6a7;
        color: #2e7d32;
      }
      .status-canceled {
        background-color: #bbdefb;
        color: #1565c0;
      }

      .highlight {
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="sidebar">
        <div class="sidebar-header">
          <img src="img/logo.svg" alt="University Logo" class="logo" />
          <div class="tops">
            <p class="hasd">ระบบยื่นคำร้อง</p>
            <p class="asdasd">
              คณะวิทยาศาสตร์และเทคโนโลยี<br />มหาวิทยาลัยธรรมศาสตร์
            </p>
          </div>
        </div>
        <nav class="sidebar-menu">
          <a
            href="javascript:void(0);"
            class="menu-item"
            onclick="updateStatus(3)"
            style="display: none"
            id="approve-button"
          >
            <img src="img/icon (4).svg" alt="Status Icon" />
            <span class="tee">อนุมัติคำร้อง</span>
          </a>

          <a
            href="javascript:void(0);"
            class="menu-item"
            onclick="updateStatus(4)"
            style="display: none"
            id="reject-button"
          >
            <img src="img/icon (5).svg" alt="Status Icon" />
            <span class="tee">ปฏิเสธคำร้อง</span>
          </a>
        </nav>
        <div class="logout-section">
          <a href="javascript:void(0);" class="menu-item" onclick="goBack()">
            <img src="img/back.svg" alt="Status Icon" />
            <span class="tee">ย้อนกลับ</span>
          </a>
          <a href="/logout" class="menu-item">
            <img src="img/Artboard3.svg" alt="Logout Icon" />
            <span class="tee">ออกจากระบบ</span>
          </a>
          <div class="user-info">
            <div class="asee">
              <img src="img/avt (1).svg" alt="Logout Icon" />
            </div>
            <div class="user-details">
              <p class="name" id="barname">เจ้าหน้าที่ ฝ่ายวิชาการ</p>
              <p class="idd" id="barid">0002</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content Section (80%) -->
      <div class="scallable">
        <h2 class="rounded-border" id="topmain">คำร้องขอจดทะเบียนล่าช้า</h2>
        <div class="middle">
          <h3 class="bold-text">ข้อมูลผู้ยื่นคำร้อง</h3>
          <dd>
            <p>ผู้ยื่น : <span class="highlight" id="student_name"></span></p>
            <p>เลขทะเบียน : <span class="highlight" id="student_id"></span></p>
            <p>ชั้นปีที่ : <span class="highlight" id="year"></span></p>
            <p>สาขาวิชา : <span class="highlight" id="major"></span></p>
            <p>
              ที่อยู่ที่ติดต่อได้ :
              <span class="highlight" id="house_number"></span>
            </p>
            <p>แขวง/ตำบล : <span class="highlight" id="sub_district"></span></p>
            <p>เขต/อำเภอ : <span class="highlight" id="district"></span></p>
            <p>จังหวัด : <span class="highlight" id="province"></span></p>
            <p>รหัสไปรษณีย์ : <span class="highlight" id="postcode"></span></p>
            <p>
              โทรศัพท์ติดต่อกับนักศึกษา :
              <span class="highlight" id="student_phone"></span>
            </p>
            <p>
              ติดต่อผู้ปกครอง :
              <span class="highlight" id="guardian_phone"></span>
            </p>
          </dd>
          <br />
          <hr />
          <br />
          <h3 class="bold-text">คำร้อง</h3>
          <dd>
            <p>ประเภท : <span class="highlight" id="petition_type"></span></p>
            <p>รหัสวิชา : <span class="highlight" id="subject_code"></span></p>
            <p>ชื่อวิชา : <span class="highlight" id="subject_name"></span></p>
            <p>กลุ่มเรียน : <span class="highlight" id="section"></span></p>
            <p>
              เหตุผลในการยื่นคำร้อง :
              <span class="highlight" id="reason"></span>
            </p>
          </dd>
          <br />
          <hr />
          <br />
          <h3 class="bold-text">เอกสารประกอบคำร้อง</h3>
          <div class="file">
            <table id="attachedFilesTable">
              <thead>
                <tr>
                  <th>ชื่อไฟล์</th>
                  <th>คำอธิบาย</th>
                  <th>ดาวน์โหลด</th>
                </tr>
              </thead>
              <tbody id="attachedFilesBody">
                <!-- ไฟล์แนบจะถูกเพิ่มที่นี่โดย JavaScript -->
              </tbody>
            </table>
          </div>
          <br /><br />
          <div class="comments-section">
            <h3>ความคิดเห็น :</h3>
            <div class="comments-grid">
              <div>
                <label for="acdemicStaff-comment">ความคิดเห็นเจ้าหน้าที่:</label>
                <textarea id="acdemicStaff-comment" readonly></textarea>
              </div>
              <div>
                <label for="advisor-comment">ความคิดเห็นอาจารย์ที่ปรึกษา:</label>
                <textarea id="advisor-comment" readonly></textarea>
              </div>
              <div>
                <label for="Lecturer-comment">ความคิดเห็นอาจารย์ผู้สอน:</label>
                <textarea id="Lecturer-comment" readonly></textarea>
              </div>
            </div>
          </div> 
          
        </div>
      </div>
    </div>

    <!-- Status and Action Buttons -->
    <div class="right">
      <h3 style="text-align: left">สถานะคำร้อง</h3>
      <div class="rounded-border2">
        <p class="asad">คำร้องถูกยื่นเมื่อ: <span id="submit_time"></span></p>
        <p class="asad">พิจารณาเมื่อ:<span id="review_time"></span></p>
        <p>เวลาพิจารณาเจ้าหน้าที่: <span id="review_time_a"></span></p>
        <p>เวลาพิจารณาอาจารย์ที่ปรึกษา: <span id="review_time_b"></span></p>
        <p>เวลาพิจารณาอาจารย์ผู้สอน: <span id="review_time_c"></span></p>
        <p class="spanlab"><span id="status"></span></p>
      </div>

      <!-- Action Buttons 
            <button class="reject-button" onclick="updateStatus(4)">ปฏิเสธคำร้อง</button>
            <button class="approve-button" onclick="updateStatus(5)">อนุมัติคำร้อง</button>-->
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const petitionId = urlParams.get("id");

      function updateStatusOnLoad() {
        fetch(`/academicStaff/petition-details/${petitionId}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.status !== 3 && data.status !== 4) {
              // อัปเดตเป็น 2 ถ้าสถานะไม่ใช่ปฏิเสธหรืออนุมัติ
              fetch(`/academicStaff/auto-update-status/${petitionId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: 2 }),
              })
                .then((response) => response.json())
                .then((updateData) => {
                  if (!updateData.success) {
                    console.error(
                      "Error updating status on load:",
                      updateData.message
                    );
                  }
                })
                .catch((error) =>
                  console.error("Error updating status on load:", error)
                );
            }
          })
          .catch((error) =>
            console.error("Error fetching petition details:", error)
          );
      }

      document.addEventListener("DOMContentLoaded", updateStatusOnLoad);

      function updateStatus(newStatus) {
        const comment = document.getElementById("acdemicStaff-comment").value || "ไม่มีความคิดเห็น";
        fetch(`/academicStaff/update-petition/${petitionId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status: newStatus, comment: comment }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("อัปเดตสถานะสำเร็จ");
              window.location.href = "/academicStaffPetitions";
            } else {
              alert("ไม่สามารถอัปเดตสถานะได้");
            }
          })
          .catch((error) =>
            console.error("Error updating petition status:", error)
          );
      }

      function goBack() {
        window.history.back();
      }

      // เรียกใช้ฟังก์ชันอัปเดตสถานะทันทีที่โหลดหน้านี้
      document.addEventListener("DOMContentLoaded", updateStatusOnLoad);

      // ฟังก์ชันแสดงประเภทคำร้อง
      function getPetitionType(type) {
        switch (parseInt(type)) {
          case 1:
            return "จดทะเบียนล่าช้า";
          case 2:
            return "ถอนรายวิชา";
          case 3:
            return "จดทะเบียนศึกษารายวิชาข้ามหลักสูตร";
          case 4:
            return "ลาออก";
          default:
            return "ไม่ทราบประเภท";
        }
      }

      // ฟังก์ชันแสดงสถานะพร้อมแถบสี
      function getStatusText(status) {
        switch (status) {
          case 2:
            return '<span class="status-label status-waiting">รอตรวจสอบ</span>';
          case 3:
            return '<span class="status-label status-read">ผ่าน</span>';
          case 4:
            return '<span class="status-label status-rejected">ปฏิเสธ/กลับไปแก้ไข</span>';
          default:
            return '<span class="status-label">ไม่ทราบสถานะ</span>';
        }
      }

      // ดึงข้อมูลคำร้องจากเซิร์ฟเวอร์
      fetch(`/academicStaff/petition-details/${petitionId}`)
        .then((response) => response.json())
        .then((data) => {
          document.getElementById("student_name").textContent =
            data.student_name || "";
          document.getElementById("student_id").textContent =
            data.student_id || "";
          document.getElementById("year").textContent = data.year || "";
          document.getElementById("major").textContent = data.major || "";
          document.getElementById("house_number").textContent =
            data.house_number || "";
          document.getElementById("sub_district").textContent =
            data.sub_district || "";
          document.getElementById("district").textContent = data.district || "";
          document.getElementById("province").textContent = data.province || "";
          document.getElementById("postcode").textContent = data.postcode || "";
          document.getElementById("student_phone").textContent =
            data.student_phone || "";
          document.getElementById("guardian_phone").textContent =
            data.guardian_phone || "";

          document.getElementById("petition_type").textContent =
            getPetitionType(data.petition_type);
          document.getElementById("subject_code").textContent =
            data.subject_code || "";
          document.getElementById("subject_name").textContent =
            data.subject_name || "";
          document.getElementById("section").textContent = data.section || "";
          document.getElementById("submit_time").textContent =
            new Date(data.submit_time).toLocaleString() || "";
          document.getElementById("status").innerHTML = getStatusText(
            data.status
          );
          document.getElementById("reason").textContent =
            data.reason || "ไม่มีเหตุผลระบุไว้"; // เพิ่มการแสดงเหตุผล
          document.getElementById("reason").textContent =
            data.reason || "ไม่มีเหตุผลระบุไว้"; // เพิ่มการแสดงเหตุผล
          
          document.getElementById("acdemicStaff-comment").textContent =
            data.comment_a || "";

          document.getElementById("advisor-comment").textContent =
            data.comment_b || "";

          document.getElementById("Lecturer-comment").textContent =
            data.comment_c || "";

          document.getElementById("review_time_a").textContent =
            data.review_time_a ? new Date(data.review_time_a).toLocaleString() : "ยังไม่มีการพิจารณา";
          document.getElementById("review_time_b").textContent =
            data.review_time_b ? new Date(data.review_time_b).toLocaleString() : "ยังไม่มีการพิจารณา";
          document.getElementById("review_time_c").textContent =
           data.review_time_c ? new Date(data.review_time_c).toLocaleString() : "ยังไม่มีการพิจารณา";

          document.getElementById("topmain").innerText =
            "แบบคำร้อง" + getPetitionType(data.petition_type);
          // ซ่อนปุ่มอนุมัติและปฏิเสธถ้าสถานะเป็น 3 หรือ 4
          //if (data.status === 3 || data.status === 4) {
          if (data.status === 2) {
            document.getElementById("reject-button").style.display = "flex";
            document.getElementById("approve-button").style.display = "flex";
            document.getElementById("acdemicStaff-comment").removeAttribute("readonly");
          }

          // แสดง review_time เฉพาะเมื่อสถานะเป็น 3 หรือ 4
          if (data.status === 3 || data.status === 4) {
            document.getElementById("review_time").textContent = new Date(
              data.review_time
            ).toLocaleString();
          } else {
            document.getElementById("review_time").parentElement.style.display =
              "none"; // ซ่อนถ้าสถานะไม่ใช่ 3 หรือ 4
          }

          // แสดงไฟล์แนบในรูปแบบตาราง
          const attachedFilesBody =
            document.getElementById("attachedFilesBody");
          if (data.attachedFiles && data.attachedFiles.length > 0) {
            data.attachedFiles.forEach((file) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                    <td>${file.file_name}</td>
                    <td>${file.description}</td>
                    <td><a href="/student/download-file/${file.file_id}" target="_blank">ดาวน์โหลด</a></td>
                `;
              attachedFilesBody.appendChild(row);
            });
          } else {
            attachedFilesBody.innerHTML =
              '<tr><td colspan="3">ไม่มีไฟล์แนบ</td></tr>';
          }
        })
        .catch((error) =>
          console.error("Error fetching petition details:", error)
        );

      /*function updateStatus(newStatus) {
        fetch(`/academicStaff/update-petition/${petitionId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",},
          body: JSON.stringify({ status: newStatus }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("อัปเดตสถานะสำเร็จ");
              window.location.href = "/academicStaffPetitions";
            } else {
              alert("ไม่สามารถอัปเดตสถานะได้");
            }
          })
          .catch((error) =>
            console.error("Error updating petition status:", error)
          );
      }

      document.addEventListener("visibilitychange", function () {
        if (document.visibilityState === "visible") {
          location.reload();
        }
      }); */
      
    </script>
  </body>
</html>
