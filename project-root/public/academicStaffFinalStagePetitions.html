<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>รายการคำร้องรอยื่นสำนักทะเบียน</title>
    <link rel="stylesheet" href="css/styleListofPetitionAcademicStaff.css" /> <!-- css/styleListofPetitionAcademicStaffFinalStage.css -->
    <link rel="stylesheet" href="css/stylesidebar.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bai+Jamjuree:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;1,200;1,300;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet"
    />
    <script defer src="./js/redirect-handler.js"></script>
  </head>
  <body>
    
    <div class="wrapper">
      <!-- Sidebar Section (20%) -->
      <div class="sidebar">
        <div class="sidebar-header">
          <img src="img/logo.svg" alt="University Logo" class="logo" />
          <div class="tops">
            <p class="hasd">ระบบยื่นคำร้อง</p>
            <p class="asdasd">
              คณะวิทยาศาสตร์และเทคโนโลยี<br />มหาวิทยาลัยธรรมศาสตร์
            </p>
          </div>
        </div>
	<p class="topnavto">รายการคำร้อง</p>
        <nav class="sidebar-menu">
          <a href="/academicStaffPetitions" class="menu-item ">
            <img src="img/Artboard2.svg" alt="Status Icon" />
            <span class="tee">ตรวจสอบเบื้องต้น</span>
          </a>
          <a href="/academicStaffForCommitteePetitions " class="menu-item ">
            <img src="img/image 13.svg" alt="Status Icon" />
            <span class="tee">รอยื่นคณบดี</span>
          </a>
          <a href="/academicStaffFinalStagePetitions" class="menu-item active">
            <img src="img/image 16.svg" alt="Status Icon" />
            <span class="tee">รอยื่นสำนักทะเบียน</span>
          </a>
        </nav>
        <div class="logout-section">
          <a href="/logout" class="menu-item">
            <img src="img/Artboard3.svg" alt="Logout Icon" />
            <span class="tee">ออกจากระบบ</span>
          </a>
          <div class="user-info">
            <div class="asee">
              <img src="img/avt (1).svg" alt="Logout Icon" />
            </div>
            <div class="user-details">
              <p class="name" id="barname">เจ้าหน้าที่ ฝ่ายวิชาการ</p>
              <p class="idd" id="barid">0002</p>
            </div>
          </div>
        </div>

        <!-- 
            <a href="/academicStaffPetitions" class="active">รายการคำร้อง</a>
            <a href="/logout">ออกจากระบบ</a>
        -->
      </div>

      <!-- Main Content Section (80%) -->
      <div class="container">
        <div class="header">
          <div class="header-button">รายการคำร้องรอยื่นสำนักทะเบียน</div>
        </div>

        <div class="sss">
          <div class="tab">
            <div class="tab">
              <button
                id="pendingButton"
                class="tab-button active"
                onclick="showPending()"
              >
                ยังไม่ได้ตรวจสอบ
              </button>
              <button
                id="reviewedButton"
                class="tab-button inactive"
                onclick="showReviewed()"
              >
                ตรวจสอบแล้ว
              </button>
            </div>
          </div>

          <div class="search-filter">
            <input type="text" placeholder="ค้นหา" id="searchInput" />
          </div>
        </div>

        <table class="table">
          <thead>
            <tr class="table-header">
              <th class="column-type coan" onclick="sortTable('petition_type')">
                ประเภท
                <span class="sort-icon" id="sort-icon-petition_type">▲▼</span>
              </th>
              <th
                class="column-subject-name coan"
                onclick="sortTable('subject_name')"
              >
                ชื่อวิชา
                <span class="sort-icon" id="sort-icon-subject_name">▲▼</span>
              </th>
              <th
                class="column-subject-code coan"
                onclick="sortTable('subject_code')"
              >
                รหัสวิชา
                <span class="sort-icon" id="sort-icon-subject_code">▲▼</span>
              </th>
              <th class="column-section coan">
                กลุ่มเรียน
              </th>
              <th
                class="column-student-name coan"
                onclick="sortTable('student_name')"
              >
                ชื่อนักศึกษา
                <span class="sort-icon" id="sort-icon-student_name">▲▼</span>
              </th>
              <th
                class="column-student-id coan"
                onclick="sortTable('student_id')"
              >
                รหัสนักศึกษา
                <span class="sort-icon" id="sort-icon-student_id">▲▼</span>
              </th>
              <th 
                class="column-date coan" 
                onclick="sortTable('submit_time')"
              >
                วันที่
                <span class="sort-icon" id="sort-icon-submit_time">▲▼</span>
              </th>
              <th class="column-time">
                เวลา
              </th>
              <th 
                class="column-status coan" 
                onclick="sortTable('status')"
              >
                สถานะ <span class="sort-icon" id="sort-icon-status">▲▼</span>
              </th>
              <th class="column-check">ตรวจสอบ</th>
            </tr>
          </thead>
          <tbody id="petition-list">
            <tr class="table-row">
              <td class="column-type">จดทะเบียนล่าช้า</td>
              <td class="column-subject-name">วิทยาการคอมพิวเตอร์เบื้องต้น</td>
              <td class="column-subject-code">CS101</td>
              <td class="column-section">01</td>
              <td class="column-student-name">สมชาย ใจดี</td>
              <td class="column-student-id">6600812345</td>
              <td class="column-date">12/11/2024</td>
              <td class="column-time">09:30</td>
              <td class="column-status">
                <span class="status-label status-waiting">รอตรวจสอบ</span>
              </td>
              <td class="column-check">
                <button class="verify-button" onclick="viewPetition(1)">
                  ตรวจสอบ
                </button>
              </td>
            </tr>
            <tr class="table-row">
              <td class="column-type">ถอนรายวิชา</td>
              <td class="column-subject-name">คณิตศาสตร์ขั้นสูง</td>
              <td class="column-subject-code">MA201</td>
              <td class="column-section">02</td>
              <td class="column-student-name">สาวิตรี รักดี</td>
              <td class="column-student-id">6600823456</td>
              <td class="column-date">13/11/2024</td>
              <td class="column-time">10:15</td>
              <td class="column-status">
                <span class="status-label status-approved">อนุมัติแล้ว</span>
              </td>
              <td class="column-check">
                <button class="verify-button" onclick="viewPetition(2)">
                  ตรวจสอบ
                </button>
              </td>
            </tr>
            <tr class="table-row">
              <td class="column-type">จดทะเบียนศึกษารายวิชาข้ามหลักสูตร</td>
              <td class="column-subject-name">ฟิสิกส์พื้นฐาน</td>
              <td class="column-subject-code">PH101</td>
              <td class="column-section">03</td>
              <td class="column-student-name">สุกัญญา คงดี</td>
              <td class="column-student-id">6600834567</td>
              <td class="column-date">14/11/2024</td>
              <td class="column-time">11:45</td>
              <td class="column-status">
                <span class="status-label status-rejected">ไม่อนุมัติ</span>
              </td>
              <td class="column-check">
                <button class="verify-button" onclick="viewPetition(3)">
                  ตรวจสอบ
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      // Variables to store petitions data
      let pendingPetitions = [];
      let reviewedPetitions = [];
      let currentView = "pending";

      // Fetch petitions data from server
      fetch("/academicStaffFinalStage/pending-petitions")
        .then((response) => response.json())
        .then((data) => {
          pendingPetitions = data; // เก็บเฉพาะ pending petitions
          renderPetitions();
         })
        .catch((error) => console.error("Error fetching pending petitions:", error));

      fetch("/academicStaffFinalStage/reviewed-petitions")
        .then((response) => response.json())
        .then((data) => {
          reviewedPetitions = data; // เก็บ reviewed petitions แยกกัน
        })
        .catch((error) => console.error("Error fetching reviewed petitions:", error));

      // ฟังก์ชันเพื่อแสดงสถานะพร้อมแถบสี
      function getStatusLabel(status) {
        switch (parseInt(status)) {
          case 13:
          return '<span class="status-label status-waiting">รอยืนเรื่องไปยังสำนักทะเบียน</span>';
          case 15:
            return '<span class="status-label status-approved">ยืนเรื่องไปยังสำนักทะเบียนแล้ว</span>';
          default:
            return '<span class="status-label ">ไม่ทราบสถานะ</span>';
        }
      }

      // ฟังก์ชันเพื่อแสดงประเภทคำร้อง
      function getPetitionType(type) {
        switch (parseInt(type)) {
          case 1:
            return "จดทะเบียนล่าช้า";
          case 2:
            return "ถอนรายวิชา";
          case 3:
            return "จดทะเบียนศึกษารายวิชาข้ามหลักสูตร";
          case 4:
            return "ลาออก";
          default:
            return "ไม่ทราบประเภท";
        }
      }

      // ฟังก์ชันเพื่อจัดการชื่อ โดยตัดคำว่า "นาย" หรือ "นางสาว" ออก
      function formatStudentName(name) {
        return name.replace(/^(นาย|นางสาว)\s*/, "");
      }

      // อัปเดตฟังก์ชัน renderPetitions เพื่อแสดงคอลัมน์สถานะพร้อมแถบสี
      function renderPetitions() {
        const petitionList = document.getElementById("petition-list");
        petitionList.innerHTML = ""; // Clear existing rows

        const petitions =
          currentView === "pending" ? pendingPetitions : reviewedPetitions;
        petitions.forEach((petition) => {
          const row = document.createElement("tr");
          row.className = "table-row";

          const submitDate = new Date(petition.submit_time);
          const petitionType = getPetitionType(petition.petition_type);
          const statusLabel = getStatusLabel(petition.status); // เรียกใช้ getStatusLabel

          // ตรวจสอบว่าถ้า petition_type == 4 (ลาออก)
          const subjectName =
            petition.petition_type == 4
              ? `ปี: ${petition.subject_code} ภาคเรียน: ${petition.semester}`
              : petition.subject_name || "N/A";
          const subjectCode =
            petition.petition_type == 4 ? "-" : petition.subject_code || "N/A";
          const section =
            petition.petition_type == 4 ? "-" : petition.section || "N/A";

          // ใช้ฟังก์ชัน formatStudentName เพื่อตัดคำนำหน้า
          const studentName = formatStudentName(petition.student_name);

          row.innerHTML = `
    <td class="column-type">${petitionType}</td>
    <td class="column-subject-name">${subjectName}</td>
    <td class="column-subject-code">${subjectCode}</td>
    <td class="column-section">${section}</td>
    <td class="column-student-name">${studentName}</td>
    <td class="column-student-id">${petition.student_id}</td>
    <td class="column-date">${submitDate.toLocaleDateString()}</td>
    <td class="column-time">${submitDate.toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit",
    })}</td>
    <td class="column-status">${statusLabel}</td>
    <td class="column-check"><button class="verify-button" onclick="viewPetition(${
      petition.petition_id
    })">ตรวจสอบ</button></td>
`;
          petitionList.appendChild(row);
        });
      }
      function showPending() {
        currentView = "pending";
        renderPetitions();

        document.getElementById("pendingButton").classList.add("active");
        document.getElementById("pendingButton").classList.remove("inactive");
        document.getElementById("reviewedButton").classList.add("inactive");
        document.getElementById("reviewedButton").classList.remove("active");
      }

      function showReviewed() {
        currentView = "reviewed";
        renderPetitions();

        document.getElementById("reviewedButton").classList.add("active");
        document.getElementById("reviewedButton").classList.remove("inactive");
        document.getElementById("pendingButton").classList.add("inactive");
        document.getElementById("pendingButton").classList.remove("active");
      }

      function viewPetition(id) {
        window.location.href = `/academicStaffFinalStagePetitionDetail.html?id=${id}`;
      }

      // Filter petitions by search input
      document
        .getElementById("searchInput")
        .addEventListener("input", function () {
          const searchQuery = this.value.toLowerCase();
          const petitions =
            currentView === "pending" ? pendingPetitions : reviewedPetitions;
          const filteredPetitions = petitions.filter(
            (petition) =>
              petition.petition_type.toLowerCase().includes(searchQuery) ||
              (petition.subject_name &&
                petition.subject_name.toLowerCase().includes(searchQuery)) ||
              petition.student_name.toLowerCase().includes(searchQuery) ||
              petition.student_id.toLowerCase().includes(searchQuery)
          );

          // Update the petition list with filtered results
          const petitionList = document.getElementById("petition-list");
          petitionList.innerHTML = ""; // Clear existing rows
          filteredPetitions.forEach((petition) => {
            const row = document.createElement("tr");
            row.className = "table-row";

            const submitDate = new Date(petition.submit_time);
            row.innerHTML = `
    <td class="column-type">${getPetitionType(petition.petition_type)}</td>
    <td class="column-subject-name">${petition.subject_name || "N/A"}</td>
    <td class="column-subject-code">${petition.subject_code || "N/A"}</td>
    <td class="column-section">${petition.section || "N/A"}</td>
    <td class="column-student-name">${petition.student_name}</td>
    <td class="column-student-id">${petition.student_id}</td>
    <td class="column-date">${submitDate.toLocaleDateString()}</td>
    <td class="column-time">${submitDate.toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit",
    })}</td>
<td class="column-status">${getStatusLabel(petition.status)}</td>
    <td class="column-check"><button class="verify-button" onclick="viewPetition(${
      petition.petition_id
    })">ตรวจสอบ</button></td>
`;

            petitionList.appendChild(row);
          });
        });

      let sortDirection = "desc";
      let sortColumn = "submit_time";

      function sortTable(column) {
        if (sortColumn === column) {
          // Toggle the sort direction if clicking the same column
          sortDirection = sortDirection === "asc" ? "desc" : "asc";
        } else {
          // Default to descending for new column
          sortDirection = "desc";
          sortColumn = column;
        }

        // Sort the petitions array
        const petitions =
          currentView === "pending" ? pendingPetitions : reviewedPetitions;
        petitions.sort((a, b) => {
          if (column === "submit_time") {
            return sortDirection === "asc"
              ? new Date(a.submit_time) - new Date(b.submit_time)
              : new Date(b.submit_time) - new Date(a.submit_time);
          } else {
            let aValue = a[column] || "";
            let bValue = b[column] || "";
            if (typeof aValue === "string") aValue = aValue.toLowerCase();
            if (typeof bValue === "string") bValue = bValue.toLowerCase();

            if (aValue < bValue) return sortDirection === "asc" ? -1 : 1;
            if (aValue > bValue) return sortDirection === "asc" ? 1 : -1;
            return 0;
          }
        });

        updateSortIcons();
        renderPetitions();
      }

      // ฟังก์ชันเพื่ออัปเดตสัญลักษณ์การเรียงลำดับที่หัวคอลัมน์
      function updateSortIcons() {
        const icons = document.querySelectorAll(".sort-icon");
        icons.forEach((icon) => (icon.textContent = "▲▼")); // Reset all icons

        const activeIcon = document.getElementById(`sort-icon-${sortColumn}`);
        if (activeIcon) {
          activeIcon.textContent = sortDirection === "asc" ? "▲" : "▼";
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Default sorting on submit_time (ล่าสุดอยู่บนสุด)
        sortTable("submit_time");
      });
    </script>
  </body>
</html>
