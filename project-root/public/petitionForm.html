<!-- project-root/public/petitionForm.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Petition Form</title>
  </head>
  <body>
    <h1>Petition Form</h1>
    <form id="petitionForm" action="/submit-petition" method="post" enctype="multipart/form-data">
    

    <label for="student_id">Student ID:</label>
    <input type="text" id="student_id" name="student_id" required><br>

    <label for="student_name">Student Name:</label>
    <input type="text" id="student_name" name="student_name" required><br>

     <label for="major">Major:</label>
    <input type="text" id="major" name="major" required><br>

    <label for="year">Year:</label>
    <input type="number" id="year" name="year" required><br>

    <label for="address">Address:</label>
    <textarea id="address" name="address" required></textarea><br>

    <label for="student_phone">Student Phone:</label>
    <input type="tel" id="student_phone" name="student_phone" required><br>

    <label for="guardian_phone">Guardian Phone:</label>
    <input type="tel" id="guardian_phone" name="guardian_phone" required><br>

    <label for="petition_type">Petition Type:</label>
    <input type="text" id="petition_type" name="petition_type" required><br>

    <label for="semester">Semester:</label>
    <input type="text" id="semester" name="semester" required><br>

    <label for="subject_code">Subject Code:</label>
    <input type="text" id="subject_code" name="subject_code"><br>

    <label for="subject_name">Subject Name:</label>
    <input type="text" id="subject_name" name="subject_name"><br>

    <label for="section">Section:</label>
    <input type="text" id="section" name="section"><br>
    <input type="hidden" id="petition_id" name="petition_id">
    <input type="file" id="attachments" name="attachments[]" multiple accept=".pdf, .doc, .docx, .jpg, .jpeg, .png"><br>

    <div id ="limit_file_message" style="color:red;"></div>
    <button type="button" onclick="submitForm(1)">Save as Draft</button>
    <button type="button" onclick="submitForm(2)">Submit Petition</button>
</form>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const petitionId = urlParams.get("petition_id"); // Get petition_id from query parameters

      // Fetch session data to populate form fields if available
      fetch("/get-session-data")
        .then((response) => response.json())
        .then((data) => {
          document.getElementById("student_id").value = data.student_id || "";
          document.getElementById("student_name").value =
            data.student_name || "";
          document.getElementById("major").value = data.department || "";
        })
        .catch((error) => console.error("Error fetching session data:", error));

      // If a petition_id is present, load the draft data for editing
      if (petitionId) {
        fetch(`/draft-petitions/${petitionId}`)
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("petition_id").value = petitionId;
            document.getElementById("year").value = data.year || "";
            document.getElementById("address").value = data.address || "";
            document.getElementById("student_phone").value =
              data.student_phone || "";
            document.getElementById("guardian_phone").value =
              data.guardian_phone || "";
            document.getElementById("petition_type").value =
              data.petition_type || "";
            document.getElementById("semester").value = data.semester || "";
            document.getElementById("subject_code").value =
              data.subject_code || "";
            document.getElementById("subject_name").value =
              data.subject_name || "";
            document.getElementById("section").value = data.section || "";
          })
          .catch((error) =>
            console.error("Error fetching draft petition data:", error)
          );
      }

        function submitForm(status) {
            const petitionId = document.getElementById('petition_id').value;
            const formData = new FormData(document.getElementById('petitionForm'));
            const data = Object.fromEntries(formData.entries());
            const fileInput = document.getElementsByName("attachments[]")[0];
         const limit_file_message = document.getElementById('limit_file_message');
            data.status = status; // Set status for draft or submit

        // If petition_id is present, update the petition; otherwise, create a new one
        const url = petitionId
          ? `/update-petition/${petitionId}`
          : "/submit-petition";
        const method = petitionId ? "PUT" : "POST";

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Redirect based on action
                    if (status === 1) {
                        window.location.href = '/draft-petitions-page'; // Redirect after saving as draft
                    } else if (status === 2) {
                        window.location.href = '/studentPetitions'; // Redirect after submitting petition
                    }
                } else {
                    alert('Error: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Error submitting form:', error);
            });
        }
        fileInput.addEventListener('change', function(e) {
             limit_file_message.innerHTML = ''
             let files = e.target.files;
             if (files.length > 10) {
                 limit_file_message.innerHTML = 'จำนวนไฟล์สูงสุด 10 ไฟล์';
                 fileInput.value = ''; // เคลียร์ไฟล์ที่เลือกไว้
             }
             console.log(files.length)
         });
         function submitForm(status) {

const petitionId = document.getElementById('petition_id').value;
const formData = new FormData(document.getElementById('petitionForm'));
formData.append('status', status);  // append status to FormData

 const url = petitionId ? `/update-petition/${petitionId}` : '/submit-petition';
 const method = petitionId ? 'PUT' : 'POST';


    fetch(url, {
        method: method,
        body: formData // Now send FormData directly
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Redirect based on action
            if (status === 1) {
                window.location.href = '/draft-petitions-page'; // Redirect after saving as draft
            } else if (status === 2) {
                window.location.href = '/studentPetitions'; // Redirect after submitting petition
            }
        } else {
            alert('Error: ' + result.message);
            console.error(result.error)
        }
    })
    .catch(error => {
        console.error('Error submitting form:', error);
    });
         }
    </script>
    <script src="/js/sessionTimeout.js"></script>
  </body>
</html>
